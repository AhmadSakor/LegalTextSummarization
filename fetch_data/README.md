# Data Preparation

[![Python Version](https://img.shields.io/badge/python-3.10%2B-blue.svg)](https://www.python.org/downloads/)



## 📋 Table of Contents
- [Overview](#-overview)
- [System Requirements](#-system-requirements)
- [Installation](#-installation)
- [Usage](#-usage)
- [Pipeline Stages](#-pipeline-stages)
- [Sample Case](#-sample-case)

## 🔍 Overview

This part automates the extraction and processing of legal cases from Morocco's Judicial Portal, transforming scanned PDF documents into structured, machine-readable JSON formats. The pipeline includes web crawling, OCR processing, and GPT-4-powered text refinement.

### Key Features:
- Automated crawling of legal cases from the [Moroccan Judicial Portal](https://juriscassation.cspj.ma/en)
- PDF to text conversion using advanced OCR techniques
- AI-powered text refinement and error correction
- Structured JSON output following a standardized template

## 💻 System Requirements

- Python 3.10 or higher
- Sufficient storage space for PDF documents
- Internet connection for web crawling and API access
- GPU recommended for OCR processing (optional)

## 🚀 Installation


1. Install required dependencies:
```bash
pip install -r requirements.txt
```

2. Install tesseract library for OCR:
```bash
apt-get install tesseract-ocr
apt-get install libtesseract-dev
apt-get install tesseract-ocr-ara  # Arabic language pack
```

## 🔧 Usage

The pipeline consists of three main stages, each executed through a dedicated script:

### 1. Data Collection
Crawl and download legal cases from the portal:
```bash
python files_crawler.py --total_pages 2522 --log_file '../logs/crawler.log' --output_dir '../data/pdf_files' --max_workers 10 --retry_connect 3 --retry_backoff 0.5
```

### 2. OCR Processing
Convert PDF files to text using OCR:
```bash
python pdf2txt.py --pdf_folder '../data/pdf_files' --output_folder '../data/text_files' --tesseract_cmd '/usr/bin/tesseract' --tessdata_prefix '/usr/share/tesseract-ocr/4.00/tessdata/'
```

### 3. Text Refinement and Structuring
Process and refine the extracted text using GPT-4:
```bash
python process_cases.py --api_key "your_api_key" --input_folder "../data/text_files" --output_folder "../data/json_files" --error_log "../logs/errors_processing.log" --errors_folder "../data/errors_files" --max_requests_per_minute 90 --rate_limit_period 60
```

remember to replace API_KEY with your OpenAI API key.
gpt-4o-mini model is used for this script considering its capabilities and low price per token.


### 4. Fix Processing Errors
Some of the GPT-4 responses are not consistent with the pre-defined template or may have some special character.
If you find files in ../data/errors_files directory, then run the following script to process files with errors then append them to the already processed files in ../data/json_files directory :
```bash
python fix_files_with_errors.py --input_folder ../data/errors_files --output_folder ../data/json_files
```


## 📝 Pipeline Stages

### Stage 1: Data Collection
- Connects to the Judicial Portal
- Downloads available legal case PDFs
- Organizes files in the appropriate directory structure

### Stage 2: OCR Processing
The OCR pipeline includes:
1. PDF to image conversion for each page
2. OCR text extraction using advanced recognition techniques
3. Concatenation of extracted text into single files
4. Output saved as `.txt` files

### Stage 3: Text Refinement
Implements GPT-4 powered processing:
- Identifies and corrects OCR errors
- Improves text coherence and readability
- Generates structured JSON summaries
- Follows predefined templates for consistency


## 📝 Sample Case

[Here](../data/sample/sample.pdf) is a sample of an original PDF file from the dataset


Below is a sample of the structured JSON output generated by our model, demonstrating how legal case information is extracted and organized:

<details>
<summary>Click to view sample JSON output</summary>

```json
{
  "case_information": {
    "case_number": "305",
    "date_of_ruling": "04 يوليوز 2023",
    "court": "محكمة النقض",
    "main_case_topic": "تطليق للشقاق",
    "parties_involved": "م.م - ه.1"
  },
  "persons_involved": [
    {
      "name": "م.م",
      "role": "مدعية"
    },
    {
      "name": "ه.1",
      "role": "مدعى عليه"
    },
    {
      "name": "ز.ص",
      "role": "نائبة المدعية"
    },
    {
      "name": "محمد عصبة",
      "role": "مستشار مقرر"
    },
    {
      "name": "محمد بترهة",
      "role": "رئيس الهيئة"
    },
    {
      "name": "عبد الفتاح الزهاوي",
      "role": "محامي عام"
    }
  ],
  "background_of_the_case": {
    "overview": "تناقش القضية طلب تطليق للشقاق بسبب سوء المعاملة والاعتداء. المدعية تطالب بالحصول على حقوقها ومصروفات البنت بعد الطلاق.",
    "relevant_dates": [
      {
        "date": "2021",
        "event": "تاريخ عقد الزواج"
      },
      {
        "date": "2022/05/24",
        "event": "صدور الحكم الابتدائي بالتطليق"
      },
      {
        "date": "2022/12/08",
        "event": "تقديم عريضة النقض"
      },
      {
        "date": "2022/11/14",
        "event": "صدور القرار الذي تم النقض عليه"
      },
      {
        "date": "2023/06/06",
        "event": "صدور الأمر بالتخلي والإبلاغ"
      },
      {
        "date": "2023/07/04",
        "event": "تعيين القضية في الجلسة العلنية"
      }
    ]
  },
  "key_issues": [
    "تقدير مستحقات الزوجة والأطفال بعد الطلاق",
    "وجود دخل مخفي للمدعى عليه",
    "صلاحية الشهادة المقدمة من قبل المدعى عليه"
  ],
  "arguments_presented": {
    "claimants_arguments": "المدعية تؤكد وجود سوء المعاملة وتطلب التطليق، وتقدم أدلة على دخل المدعى عليه العالي من خلال شركة يملكها.",
    "defendants_arguments": "المدعى عليه ينكر وجود دخل كتقاضيه 0 درهم، مشيراً إلى أن الشركة تعود لصديقه، ويعرب عن عدم القدرة على تحمل المستحقات المقررة."
  },
  "courts_findings": {
    "evidence_reviewed": "شهادات طرفي النزاع وتصريحات ضريبية.",
    "rulings_made": "رفضت محكمة النقض طلب المدعى عليه وأيدت الحكم الابتدائي.",
    "legal_principles_applied": [
      "المواد 84 و85 و189 و190 من مدونة الأسرة"
    ]
  },
  "outcome": {
    "final_decision": "رفض الطلب وتحميل الطالب المصاريف.",
    "implications": "يبقى الحكم الابتدائي ساري المفعول ويؤكد على مسؤولية المدعى عليه في توفير مصروفات البنت."
  },
  "additional_notes": {
    "observations": "النزاع ينبه إلى أهمية الشهادات الموثوقة في القضايا العائلية."
  }
}
```
</details>


