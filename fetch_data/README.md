# Data Preparation

[![Python Version](https://img.shields.io/badge/python-3.10%2B-blue.svg)](https://www.python.org/downloads/)



## ğŸ“‹ Table of Contents
- [Overview](#-overview)
- [System Requirements](#-system-requirements)
- [Installation](#-installation)
- [Usage](#-usage)
- [Pipeline Stages](#-pipeline-stages)
- [Sample Case](#-sample-case)

## ğŸ” Overview

This part automates the extraction and processing of legal cases from Morocco's Judicial Portal, transforming scanned PDF documents into structured, machine-readable JSON formats. The pipeline includes web crawling, OCR processing, and GPT-4-powered text refinement.

### Key Features:
- Automated crawling of legal cases from the [Moroccan Judicial Portal](https://juriscassation.cspj.ma/en)
- PDF to text conversion using advanced OCR techniques
- AI-powered text refinement and error correction
- Structured JSON output following a standardized template

## ğŸ’» System Requirements

- Python 3.10 or higher
- Sufficient storage space for PDF documents
- Internet connection for web crawling and API access
- GPU recommended for OCR processing (optional)

## ğŸš€ Installation


1. Install required dependencies:
```bash
pip install -r requirements.txt
```

2. Install tesseract library for OCR:
```bash
apt-get install tesseract-ocr
apt-get install libtesseract-dev
apt-get install tesseract-ocr-ara  # Arabic language pack
```

## ğŸ”§ Usage

The pipeline consists of three main stages, each executed through a dedicated script:

### 1. Data Collection
Crawl and download legal cases from the portal:
```bash
python files_crawler.py --total_pages 2522 --log_file '../logs/crawler.log' --output_dir '../data/pdf_files' --max_workers 10 --retry_connect 3 --retry_backoff 0.5
```

### 2. OCR Processing
Convert PDF files to text using OCR:
```bash
python pdf2txt.py --pdf_folder '../data/pdf_files' --output_folder '../data/text_files' --tesseract_cmd '/usr/bin/tesseract' --tessdata_prefix '/usr/share/tesseract-ocr/4.00/tessdata/'
```

### 3. Text Refinement and Structuring
Process and refine the extracted text using GPT-4:
```bash
python process_cases.py --api_key "your_api_key" --input_folder "../data/text_files" --output_folder "../data/json_files" --error_log "../logs/errors_processing.log" --errors_folder "../data/errors_files" --max_requests_per_minute 90 --rate_limit_period 60
```

remember to replace API_KEY with your OpenAI API key.
gpt-4o-mini model is used for this script considering its capabilities and low price per token.


### 4. Fix Processing Errors
Some of the GPT-4 responses are not consistent with the pre-defined template or may have some special character.
If you find files in ../data/errors_files directory, then run the following script to process files with errors then append them to the already processed files in ../data/json_files directory :
```bash
python fix_files_with_errors.py --input_folder ../data/errors_files --output_folder ../data/json_files
```


## ğŸ“ Pipeline Stages

### Stage 1: Data Collection
- Connects to the Judicial Portal
- Downloads available legal case PDFs
- Organizes files in the appropriate directory structure

### Stage 2: OCR Processing
The OCR pipeline includes:
1. PDF to image conversion for each page
2. OCR text extraction using advanced recognition techniques
3. Concatenation of extracted text into single files
4. Output saved as `.txt` files

### Stage 3: Text Refinement
Implements GPT-4 powered processing:
- Identifies and corrects OCR errors
- Improves text coherence and readability
- Generates structured JSON summaries
- Follows predefined templates for consistency


## ğŸ“ Sample Case

[Here](../data/sample/sample.pdf) is a sample of an original PDF file from the dataset


Below is a sample of the structured JSON output generated by our model, demonstrating how legal case information is extracted and organized:

<details>
<summary>Click to view sample JSON output</summary>

```json
{
  "case_information": {
    "case_number": "305",
    "date_of_ruling": "04 ÙŠÙˆÙ„ÙŠÙˆØ² 2023",
    "court": "Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ù†Ù‚Ø¶",
    "main_case_topic": "ØªØ·Ù„ÙŠÙ‚ Ù„Ù„Ø´Ù‚Ø§Ù‚",
    "parties_involved": "Ù….Ù… - Ù‡.1"
  },
  "persons_involved": [
    {
      "name": "Ù….Ù…",
      "role": "Ù…Ø¯Ø¹ÙŠØ©"
    },
    {
      "name": "Ù‡.1",
      "role": "Ù…Ø¯Ø¹Ù‰ Ø¹Ù„ÙŠÙ‡"
    },
    {
      "name": "Ø².Øµ",
      "role": "Ù†Ø§Ø¦Ø¨Ø© Ø§Ù„Ù…Ø¯Ø¹ÙŠØ©"
    },
    {
      "name": "Ù…Ø­Ù…Ø¯ Ø¹ØµØ¨Ø©",
      "role": "Ù…Ø³ØªØ´Ø§Ø± Ù…Ù‚Ø±Ø±"
    },
    {
      "name": "Ù…Ø­Ù…Ø¯ Ø¨ØªØ±Ù‡Ø©",
      "role": "Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‡ÙŠØ¦Ø©"
    },
    {
      "name": "Ø¹Ø¨Ø¯ Ø§Ù„ÙØªØ§Ø­ Ø§Ù„Ø²Ù‡Ø§ÙˆÙŠ",
      "role": "Ù…Ø­Ø§Ù…ÙŠ Ø¹Ø§Ù…"
    }
  ],
  "background_of_the_case": {
    "overview": "ØªÙ†Ø§Ù‚Ø´ Ø§Ù„Ù‚Ø¶ÙŠØ© Ø·Ù„Ø¨ ØªØ·Ù„ÙŠÙ‚ Ù„Ù„Ø´Ù‚Ø§Ù‚ Ø¨Ø³Ø¨Ø¨ Ø³ÙˆØ¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØ§Ù„Ø§Ø¹ØªØ¯Ø§Ø¡. Ø§Ù„Ù…Ø¯Ø¹ÙŠØ© ØªØ·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ‚Ù‡Ø§ ÙˆÙ…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¨Ù†Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø§Ù‚.",
    "relevant_dates": [
      {
        "date": "2021",
        "event": "ØªØ§Ø±ÙŠØ® Ø¹Ù‚Ø¯ Ø§Ù„Ø²ÙˆØ§Ø¬"
      },
      {
        "date": "2022/05/24",
        "event": "ØµØ¯ÙˆØ± Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ Ø¨Ø§Ù„ØªØ·Ù„ÙŠÙ‚"
      },
      {
        "date": "2022/12/08",
        "event": "ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±ÙŠØ¶Ø© Ø§Ù„Ù†Ù‚Ø¶"
      },
      {
        "date": "2022/11/14",
        "event": "ØµØ¯ÙˆØ± Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„Ù†Ù‚Ø¶ Ø¹Ù„ÙŠÙ‡"
      },
      {
        "date": "2023/06/06",
        "event": "ØµØ¯ÙˆØ± Ø§Ù„Ø£Ù…Ø± Ø¨Ø§Ù„ØªØ®Ù„ÙŠ ÙˆØ§Ù„Ø¥Ø¨Ù„Ø§Øº"
      },
      {
        "date": "2023/07/04",
        "event": "ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø¶ÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ù„Ù†ÙŠØ©"
      }
    ]
  },
  "key_issues": [
    "ØªÙ‚Ø¯ÙŠØ± Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ø²ÙˆØ¬Ø© ÙˆØ§Ù„Ø£Ø·ÙØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø§Ù‚",
    "ÙˆØ¬ÙˆØ¯ Ø¯Ø®Ù„ Ù…Ø®ÙÙŠ Ù„Ù„Ù…Ø¯Ø¹Ù‰ Ø¹Ù„ÙŠÙ‡",
    "ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯Ø¹Ù‰ Ø¹Ù„ÙŠÙ‡"
  ],
  "arguments_presented": {
    "claimants_arguments": "Ø§Ù„Ù…Ø¯Ø¹ÙŠØ© ØªØ¤ÙƒØ¯ ÙˆØ¬ÙˆØ¯ Ø³ÙˆØ¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØªØ·Ù„Ø¨ Ø§Ù„ØªØ·Ù„ÙŠÙ‚ØŒ ÙˆØªÙ‚Ø¯Ù… Ø£Ø¯Ù„Ø© Ø¹Ù„Ù‰ Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¯Ø¹Ù‰ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù…Ù† Ø®Ù„Ø§Ù„ Ø´Ø±ÙƒØ© ÙŠÙ…Ù„ÙƒÙ‡Ø§.",
    "defendants_arguments": "Ø§Ù„Ù…Ø¯Ø¹Ù‰ Ø¹Ù„ÙŠÙ‡ ÙŠÙ†ÙƒØ± ÙˆØ¬ÙˆØ¯ Ø¯Ø®Ù„ ÙƒØªÙ‚Ø§Ø¶ÙŠÙ‡ 0 Ø¯Ø±Ù‡Ù…ØŒ Ù…Ø´ÙŠØ±Ø§Ù‹ Ø¥Ù„Ù‰ Ø£Ù† Ø§Ù„Ø´Ø±ÙƒØ© ØªØ¹ÙˆØ¯ Ù„ØµØ¯ÙŠÙ‚Ù‡ØŒ ÙˆÙŠØ¹Ø±Ø¨ Ø¹Ù† Ø¹Ø¯Ù… Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ ØªØ­Ù…Ù„ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ù…Ù‚Ø±Ø±Ø©."
  },
  "courts_findings": {
    "evidence_reviewed": "Ø´Ù‡Ø§Ø¯Ø§Øª Ø·Ø±ÙÙŠ Ø§Ù„Ù†Ø²Ø§Ø¹ ÙˆØªØµØ±ÙŠØ­Ø§Øª Ø¶Ø±ÙŠØ¨ÙŠØ©.",
    "rulings_made": "Ø±ÙØ¶Øª Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ù†Ù‚Ø¶ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø¯Ø¹Ù‰ Ø¹Ù„ÙŠÙ‡ ÙˆØ£ÙŠØ¯Øª Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ.",
    "legal_principles_applied": [
      "Ø§Ù„Ù…ÙˆØ§Ø¯ 84 Ùˆ85 Ùˆ189 Ùˆ190 Ù…Ù† Ù…Ø¯ÙˆÙ†Ø© Ø§Ù„Ø£Ø³Ø±Ø©"
    ]
  },
  "outcome": {
    "final_decision": "Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ.",
    "implications": "ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ Ø³Ø§Ø±ÙŠ Ø§Ù„Ù…ÙØ¹ÙˆÙ„ ÙˆÙŠØ¤ÙƒØ¯ Ø¹Ù„Ù‰ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø§Ù„Ù…Ø¯Ø¹Ù‰ Ø¹Ù„ÙŠÙ‡ ÙÙŠ ØªÙˆÙÙŠØ± Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¨Ù†Øª."
  },
  "additional_notes": {
    "observations": "Ø§Ù„Ù†Ø²Ø§Ø¹ ÙŠÙ†Ø¨Ù‡ Ø¥Ù„Ù‰ Ø£Ù‡Ù…ÙŠØ© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø© ÙÙŠ Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ©."
  }
}
```
</details>


